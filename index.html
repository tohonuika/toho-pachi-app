<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>パチンコ専用 台診断アプリ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 1rem;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 2rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        input[type="number"], input[type="file"] {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            display: block;
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        pre {
            background: #eee;
            padding: 1rem;
            overflow-x: auto;
            white-space: pre-wrap;
            border-radius: 4px;
        }
        .result {
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>パチンコ専用 台診断アプリ</h1>

        <!-- Manual input section -->
        <div class="section">
            <h2>手入力モード</h2>
            <p>データ機の画面を見ながら数値を入力してください。合成確率は 1/X の X の部分、総回転数、差枚／差玉（マイナスは - を付ける）。</p>
            <label for="gousei">合成確率 (1/X の X の部分)</label>
            <input type="number" id="gousei" min="1" step="1" placeholder="例: 169">
            <label for="spin">総回転数</label>
            <input type="number" id="spin" min="0" step="1" placeholder="例: 2200">
            <label for="diff">差枚／差玉</label>
            <input type="number" id="diff" step="1" placeholder="例: -2500">
            <button id="manualBtn">スコア計算</button>
            <div id="manualResult" class="result"></div>
        </div>

        <hr>

        <!-- Image upload section -->
        <div class="section">
            <h2>画像解析モード</h2>
            <p>データ機の画面を写真で撮ってアップロードすると、自動でOCR解析します。</p>
            <input type="file" id="imageInput" accept="image/*">
            <button id="imageBtn" disabled>画像を解析</button>
            <div id="imageResult" class="result"></div>
        </div>
    </div>

    <script>
        // ここにAPIのベースURLを設定してください。
        // 例: 'https://your-backend.onrender.com'
        const API_BASE_URL = 'https://toho-pachi-backend.onrender.com';

        // 手入力モード
        const manualBtn = document.getElementById('manualBtn');
        const manualResult = document.getElementById('manualResult');

        manualBtn.addEventListener('click', async () => {
            const gouseiValue = document.getElementById('gousei').value;
            const spinValue = document.getElementById('spin').value;
            const diffValue = document.getElementById('diff').value;
            // 入力チェック
            if (!gouseiValue || !spinValue || diffValue === '') {
                manualResult.textContent = 'すべての数値を入力してください。';
                return;
            }
            manualBtn.disabled = true;
            manualResult.textContent = '解析中...';
          try {
    const response = await fetch(`${API_BASE_URL}/analyze_manual`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            gousei_prob: parseFloat(gouseiValue),
            total_spin: parseFloat(spinValue),
            diff: parseFloat(diffValue)
        })
    });

    // レスポンス本文を一度テキストとして受け取る
    const text = await response.text();

    if (!response.ok) {
        // HTTPステータスとサーバーからのエラーメッセージをそのまま表示
        manualResult.textContent = `HTTP ${response.status} : ${text}`;
        console.error('analyze_manual error', response.status, text);
        return;
    }

    const data = JSON.parse(text);
    manualResult.innerHTML = `<strong>スコア: ${data.score}</strong><br>コメント: ${data.comment}<br><details><summary>詳細情報を見る</summary><pre>${JSON.stringify(data, null, 2)}</pre></details>`;
} catch (err) {
    manualResult.textContent = `Fetchエラー: ${err.message}`;
    console.error(err);
} finally {
    manualBtn.disabled = false;
}
        });

        // 画像解析モード
        const imageInput = document.getElementById('imageInput');
        const imageBtn = document.getElementById('imageBtn');
        const imageResult = document.getElementById('imageResult');

        imageInput.addEventListener('change', () => {
            if (imageInput.files && imageInput.files.length > 0) {
                imageBtn.disabled = false;
            } else {
                imageBtn.disabled = true;
            }
        });

        imageBtn.addEventListener('click', async () => {
            const file = imageInput.files[0];
            if (!file) {
                imageResult.textContent = '画像ファイルを選択してください。';
                return;
            }
            imageBtn.disabled = true;
            imageResult.textContent = '解析中...';
            const formData = new FormData();
            formData.append('image', file);
            try {
                const response = await fetch(`${API_BASE_URL}/analyze`, {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    throw new Error('エラーが発生しました');
                }
                const data = await response.json();
                imageResult.innerHTML = `<strong>スコア: ${data.score}</strong><br>コメント: ${data.comment}<br><details><summary>詳細情報を見る</summary><pre>${JSON.stringify(data, null, 2)}</pre></details>`;
            } catch (err) {
                imageResult.textContent = err.message;
            } finally {
                imageBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
