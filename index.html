<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台シミュレーション診断アプリ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 1rem;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 1.5rem;
        }
        h2 {
            margin-bottom: 0.5rem;
        }
        p {
            margin-top: 0;
            font-size: 0.9rem;
            color: #555;
        }
        label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: bold;
            font-size: 0.9rem;
        }
        input[type="number"] {
            width: 100%;
            padding: 0.4rem 0.5rem;
            margin-bottom: 0.3rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9rem;
            box-sizing: border-box;
        }
        button {
            display: inline-block;
            padding: 0.6rem 1rem;
            font-size: 1rem;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 0.3rem;
            text-align: center;
        }
        th {
            background-color: #f0f0f0;
        }
        .info-box {
            background: #f9fafb;
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid #3b82f6;
            font-size: 0.85rem;
        }
        .badge {
            display: inline-block;
            border-radius: 999px;
            padding: 0.15rem 0.6rem;
            font-size: 0.7rem;
            background: #e5e7eb;
            color: #374151;
        }
        /* 日別カード用 */
        .day-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .day-card {
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 0.75rem 0.9rem 0.6rem;
            position: relative;
        }
        .day-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
            font-size: 0.8rem;
            color: #4b5563;
        }
        .day-chip {
            background: #e5e7eb;
            border-radius: 999px;
            padding: 0.15rem 0.6rem;
            font-size: 0.7rem;
        }
        .day-caption {
            font-size: 0.75rem;
            color: #6b7280;
        }
        .day-card-body {
            margin-top: 0.2rem;
        }
        .field-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }
        .field {
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>台シミュレーション診断アプリ</h1>

    <!-- 台スペック入力 -->
    <div class="section">
        <h2>① 台スペック入力</h2>
        <p>大当たり分母・継続率・1回転あたりの投資を入力してください。（シミュレーション回数は内部で自動設定：現在 10,000 回）</p>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:0.75rem;">
            <div>
                <label for="hit_prob_den">大当たり確率の分母 (例: 319)</label>
                <input type="number" id="hit_prob_den" min="1" step="1" placeholder="例: 319">
            </div>
            <div>
                <label for="continue_prob">継続率 (％, 例: 81)</label>
                <input type="number" id="continue_prob" min="0" max="100" step="0.1" placeholder="例: 81">
            </div>
            <div>
                <label for="cost_per_spin">1回転あたりの投資 (玉 or 円)</label>
                <input type="number" id="cost_per_spin" min="0" step="0.1" placeholder="例: 4">
            </div>
        </div>
        <div class="info-box">
            ※ Render 無料枠でも耐えるように、モンテカルロ試行回数は内部で 10,000 回に固定しています。
        </div>
    </div>

    <!-- 7日前〜当日データ -->
    <div class="section">
        <h2>② 過去7日 + 当日データ</h2>
        <p>
            7日前〜1日前のデータと、当日の途中までのデータを入力してください。<br>
            最低限、<strong>総回転数 / 大当り回数 / 差玉</strong> があればOKです。
        </p>

        <div class="day-grid">
            <!-- day1: 7日前 -->
            <div class="day-card">
                <div class="day-card-header">
                    <span class="day-chip">7日前</span>
                    <span class="day-caption">一番古い日</span>
                </div>
                <div class="day-card-body">
                    <div class="field-row">
                        <div class="field">
                            <label>総回転数</label>
                            <input type="number" name="day1_total_spins" step="1">
                        </div>
                        <div class="field">
                            <label>大当り回数</label>
                            <input type="number" name="day1_total_hits" step="1">
                        </div>
                    </div>
                    <div class="field-row">
                        <div class="field">
                            <label>差玉</label>
                            <input type="number" name="day1_net_diff" step="1">
                        </div>
                        <div class="field">
                            <label>1セット最大出玉</label>
                            <input type="number" name="day1_one_set_max" step="1">
                        </div>
                        <div class="field">
                            <label>最大連チャン数</label>
                            <input type="number" name="day1_max_chain_len" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- day2: 6日前 -->
            <div class="day-card">
                <div class="day-card-header">
                    <span class="day-chip">6日前</span>
                </div>
                <div class="day-card-body">
                    <div class="field-row">
                        <div class="field">
                            <label>総回転数</label>
                            <input type="number" name="day2_total_spins" step="1">
                        </div>
                        <div class="field">
                            <label>大当り回数</label>
                            <input type="number" name="day2_total_hits" step="1">
                        </div>
                    </div>
                    <div class="field-row">
                        <div class="field">
                            <label>差玉</label>
                            <input type="number" name="day2_net_diff" step="1">
                        </div>
                        <div class="field">
                            <label>1セット最大出玉</label>
                            <input type="number" name="day2_one_set_max" step="1">
                        </div>
                        <div class="field">
                            <label>最大連チャン数</label>
                            <input type="number" name="day2_max_chain_len" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- day3: 5日前 -->
            <div class="day-card">
                <div class="day-card-header">
                    <span class="day-chip">5日前</span>
                </div>
                <div class="day-card-body">
                    <div class="field-row">
                        <div class="field">
                            <label>総回転数</label>
                            <input type="number" name="day3_total_spins" step="1">
                        </div>
                        <div class="field">
                            <label>大当り回数</label>
                            <input type="number" name="day3_total_hits" step="1">
                        </div>
                    </div>
                    <div class="field-row">
                        <div class="field">
                            <label>差玉</label>
                            <input type="number" name="day3_net_diff" step="1">
                        </div>
                        <div class="field">
                            <label>1セット最大出玉</label>
                            <input type="number" name="day3_one_set_max" step="1">
                        </div>
                        <div class="field">
                            <label>最大連チャン数</label>
                            <input type="number" name="day3_max_chain_len" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- day4: 4日前 -->
            <div class="day-card">
                <div class="day-card-header">
                    <span class="day-chip">4日前</span>
                </div>
                <div class="day-card-body">
                    <div class="field-row">
                        <div class="field">
                            <label>総回転数</label>
                            <input type="number" name="day4_total_spins" step="1">
                        </div>
                        <div class="field">
                            <label>大当り回数</label>
                            <input type="number" name="day4_total_hits" step="1">
                        </div>
                    </div>
                    <div class="field-row">
                        <div class="field">
                            <label>差玉</label>
                            <input type="number" name="day4_net_diff" step="1">
                        </div>
                        <div class="field">
                            <label>1セット最大出玉</label>
                            <input type="number" name="day4_one_set_max" step="1">
                        </div>
                        <div class="field">
                            <label>最大連チャン数</label>
                            <input type="number" name="day4_max_chain_len" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- day5: 3日前 -->
            <div class="day-card">
                <div class="day-card-header">
                    <span class="day-chip">3日前</span>
                </div>
                <div class="day-card-body">
                    <div class="field-row">
                        <div class="field">
                            <label>総回転数</label>
                            <input type="number" name="day5_total_spins" step="1">
                        </div>
                        <div class="field">
                            <label>大当り回数</label>
                            <input type="number" name="day5_total_hits" step="1">
                        </div>
                    </div>
                    <div class="field-row">
                        <div class="field">
                            <label>差玉</label>
                            <input type="number" name="day5_net_diff" step="1">
                        </div>
                        <div class="field">
                            <label>1セット最大出玉</label>
                            <input type="number" name="day5_one_set_max" step="1">
                        </div>
                        <div class="field">
                            <label>最大連チャン数</label>
                            <input type="number" name="day5_max_chain_len" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- day6: 2日前 -->
            <div class="day-card">
                <div class="day-card-header">
                    <span class="day-chip">2日前</span>
                </div>
                <div class="day-card-body">
                    <div class="field-row">
                        <div class="field">
                            <label>総回転数</label>
                            <input type="number" name="day6_total_spins" step="1">
                        </div>
                        <div class="field">
                            <label>大当り回数</label>
                            <input type="number" name="day6_total_hits" step="1">
                        </div>
                    </div>
                    <div class="field-row">
                        <div class="field">
                            <label>差玉</label>
                            <input type="number" name="day6_net_diff" step="1">
                        </div>
                        <div class="field">
                            <label>1セット最大出玉</label>
                            <input type="number" name="day6_one_set_max" step="1">
                        </div>
                        <div class="field">
                            <label>最大連チャン数</label>
                            <input type="number" name="day6_max_chain_len" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- day7: 1日前 -->
            <div class="day-card">
                <div class="day-card-header">
                    <span class="day-chip">1日前</span>
                </div>
                <div class="day-card-body">
                    <div class="field-row">
                        <div class="field">
                            <label>総回転数</label>
                            <input type="number" name="day7_total_spins" step="1">
                        </div>
                        <div class="field">
                            <label>大当り回数</label>
                            <input type="number" name="day7_total_hits" step="1">
                        </div>
                    </div>
                    <div class="field-row">
                        <div class="field">
                            <label>差玉</label>
                            <input type="number" name="day7_net_diff" step="1">
                        </div>
                        <div class="field">
                            <label>1セット最大出玉</label>
                            <input type="number" name="day7_one_set_max" step="1">
                        </div>
                        <div class="field">
                            <label>最大連チャン数</label>
                            <input type="number" name="day7_max_chain_len" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- day8: 当日(途中まで) -->
            <div class="day-card">
                <div class="day-card-header">
                    <span class="day-chip">当日(途中まで)</span>
                    <span class="day-caption">昼から打つとき用</span>
                </div>
                <div class="day-card-body">
                    <div class="field-row">
                        <div class="field">
                            <label>総回転数</label>
                            <input type="number" name="day8_total_spins" step="1">
                        </div>
                        <div class="field">
                            <label>大当り回数</label>
                            <input type="number" name="day8_total_hits" step="1">
                        </div>
                    </div>
                    <div class="field-row">
                        <div class="field">
                            <label>差玉</label>
                            <input type="number" name="day8_net_diff" step="1">
                        </div>
                        <div class="field">
                            <label>1セット最大出玉</label>
                            <input type="number" name="day8_one_set_max" step="1">
                        </div>
                        <div class="field">
                            <label>最大連チャン数</label>
                            <input type="number" name="day8_max_chain_len" step="1">
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="info-box" style="margin-top:0.75rem;">
            ※ 何も入力のない枠は無視されます。<br>
            ※ 当日の途中までの履歴がある場合は、一番下の「当日(途中まで)」に入力してください。
        </div>
    </div>

    <!-- 実行ボタン & 結果 -->
    <div class="section">
        <h2>③ シミュレーション実行</h2>
        <button id="simulateBtn">シミュレーション実行</button>
        <div id="result" class="result"></div>
    </div>
</div>

<script>
    // バックエンドのURL（RenderにデプロイしたURLに合わせて変更）
    // 例: 'https://toho-pachi-backend.onrender.com'
    const API_BASE_URL = 'https://toho-pachi-backend.onrender.com';

    const simulateBtn = document.getElementById('simulateBtn');
    const resultDiv   = document.getElementById('result');

    function getInputValue(name) {
        const el = document.querySelector(`[name="${name}"]`);
        return el ? el.value : '';
    }

    simulateBtn.addEventListener('click', async () => {
        const hitProbDen   = document.getElementById('hit_prob_den').value;
        const continueProb = document.getElementById('continue_prob').value;
        const costPerSpin  = document.getElementById('cost_per_spin').value;

        if (!hitProbDen || !continueProb || !costPerSpin) {
            resultDiv.textContent = '大当たり分母・継続率・1回転あたり投資は必須です。';
            return;
        }

        // 日別データをまとめる
        const days = [];
        for (let i = 1; i <= 8; i++) {
            const spins = getInputValue(`day${i}_total_spins`);
            const hits  = getInputValue(`day${i}_total_hits`);
            const diff  = getInputValue(`day${i}_net_diff`);
            const oneMax = getInputValue(`day${i}_one_set_max`);
            const maxChain = getInputValue(`day${i}_max_chain_len`);

            // 全部空ならスキップ
            if (!spins && !hits && !diff && !oneMax && !maxChain) {
                continue;
            }

            days.push({
                total_spins: spins ? parseInt(spins, 10) : 0,
                total_hits: hits ? parseInt(hits, 10) : 0,
                net_diff: diff ? parseFloat(diff) : 0,
                one_set_max: oneMax ? parseFloat(oneMax) : 0,
                max_chain_len: maxChain ? parseInt(maxChain, 10) : 0
            });
        }

        if (days.length === 0) {
            resultDiv.textContent = '少なくとも1日分のデータを入力してください。';
            return;
        }

        simulateBtn.disabled = true;
        resultDiv.textContent = 'シミュレーション中...';

        try {
            const payload = {
                hit_prob_den: parseFloat(hitProbDen),
                continue_prob: parseFloat(continueProb),
                cost_per_spin: parseFloat(costPerSpin),
                days: days   // n_sim は送らない（サーバ側で固定）
            };

            const response = await fetch(`${API_BASE_URL}/simulate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const text = await response.text();

            if (!response.ok) {
                resultDiv.textContent = `HTTP ${response.status} : ${text}`;
                console.error('simulate error', response.status, text);
                return;
            }

            const data = JSON.parse(text);
            renderResult(data);
        } catch (err) {
            console.error(err);
            resultDiv.textContent = `Fetchエラー: ${err.message}`;
        } finally {
            simulateBtn.disabled = false;
        }
    });

    function renderResult(data) {
        if (!data.top5 || data.top5.length === 0) {
            resultDiv.textContent = '有効な結果がありません。入力を確認してください。';
            return;
        }

        const avgPayout = data.avg_payout_per_hit.toFixed(1);
        const oneSetMax = data.one_set_max_est.toFixed(1);
        const expTh = data.explosion_threshold.toFixed(1);

        const rowsHtml = data.top5.map((row, idx) => {
            // day_index: 1〜8 → ラベル
            let label;
            if (row.day_index === 1) label = '7日前';
            else if (row.day_index === 2) label = '6日前';
            else if (row.day_index === 3) label = '5日前';
            else if (row.day_index === 4) label = '4日前';
            else if (row.day_index === 5) label = '3日前';
            else if (row.day_index === 6) label = '2日前';
            else if (row.day_index === 7) label = '1日前';
            else label = '当日(途中まで)';

            const winRate = (row.win_rate * 100).toFixed(1) + '%';
            const avgProfit = row.avg_profit.toFixed(0);
            const maxInvest90 = row.max_invest_90.toFixed(0);
            const maxPayout90 = row.max_payout_90.toFixed(0);
            const explosionRate = (row.explosion_rate * 100).toFixed(1) + '%';
            const explosionSpins = row.explosion_rate > 0 ? row.explosion_spins_avg.toFixed(0) : '-';
            const explosionInvest = row.explosion_rate > 0 ? row.explosion_invest_avg.toFixed(0) : '-';

            return `
                <tr>
                    <td>${idx + 1}</td>
                    <td>${label}</td>
                    <td>${winRate}</td>
                    <td>${avgProfit}</td>
                    <td>${maxInvest90}</td>
                    <td>${maxPayout90}</td>
                    <td>${explosionRate}</td>
                    <td>${explosionSpins}</td>
                    <td>${explosionInvest}</td>
                </tr>
            `;
        }).join('');

        resultDiv.innerHTML = `
            <div class="info-box">
                <div><span class="badge">内部推定</span> 1回の大当り平均出玉: <strong>${avgPayout}</strong></div>
                <div><span class="badge">内部推定</span> 1セット上限(目安): <strong>${oneSetMax}</strong></div>
                <div><span class="badge">爆発条件</span> 連チャン1発あたり合計出玉が <strong>${expTh}</strong> を超えたら「爆発」と判定</div>
                <div style="margin-top:0.25rem;font-size:0.8rem;color:#6b7280;">
                    ※ モンテカルロ試行回数: <strong>${data.n_sim}</strong> 回
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>順位</th>
                        <th>日</th>
                        <th>勝率</th>
                        <th>平均差玉</th>
                        <th>最大投資(90%目安)</th>
                        <th>最大出玉(90%目安)</th>
                        <th>爆発が起きる確率</th>
                        <th>爆発まで平均回転数</th>
                        <th>爆発まで平均投資額</th>
                    </tr>
                </thead>
                <tbody>
                    ${rowsHtml}
                </tbody>
            </table>
            <p style="font-size:0.8rem;color:#666;margin-top:0.5rem;">
                ※「爆発まで平均回転数 / 投資額」は、そのシナリオ内で実際に大きな連チャン（爆発）が起きたケースのみを平均しています。
            </p>
        `;
    }
</script>
</body>
</html>
